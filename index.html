<!DOCTYPE html><html lang="ru"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>Redis</title><meta name="author" content="Иван Пономарев"><link rel="stylesheet" href="reveal.js-3.9.2/css/reset.css"><link rel="stylesheet" href="reveal.js-3.9.2/css/reveal.css"><link rel="stylesheet" href="white_course.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* listing block */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}
</style><link rel="stylesheet" href="./font-awesome-4.7.0/css/font-awesome.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
tex2jax: {
  inlineMath: [["\\(", "\\)"]],
  displayMath: [["\\[", "\\]"]],
  ignoreClass: "nostem|nolatexmath"
},
asciimath2jax: {
  delimiters: [["\\$", "\\$"]],
  ignoreClass: "nostem|noasciimath"
},
TeX: { equationNumbers: { autoNumber: "none" } }
});</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script><!--Printing and PDF exports--><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "reveal.js-3.9.2/css/print/pdf.css" : "reveal.js-3.9.2/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title"><h1>Redis</h1><p class="author"><small>Иван Пономарев</small></p></section><section id="_что_такое_redis"><div class="slide-content"><div class="imageblock"><img src="images/logo.svg" alt="logo"></div>
<div class="ulist"><ul><li><p><strong>Re</strong>mote <strong>Di</strong>ctionary <strong>S</strong>erver</p></li><li><p>In-memory key–value database</p></li><li><p>Different kinds of abstract data structure</p></li></ul></div></div></section>
<section id="_популярность"><div class="slide-content"><div class="imageblock"><img src="images/overall.png" alt="overall"></div>
<div class="paragraph"><p><a href="https://db-engines.com/en/ranking" class="bare">https://db-engines.com/en/ranking</a></p></div></div></section>
<section id="_популярность_2"><div class="slide-content"><div class="imageblock"><img src="images/popularity.png" alt="popularity"></div>
<div class="paragraph"><p><a href="https://db-engines.com/en/ranking/key-value+store" class="bare">https://db-engines.com/en/ranking/key-value+store</a></p></div></div></section>
<section id="_масштаб_пользователей"><h2>Масштаб пользователей</h2><div class="slide-content"><div class="paragraph"><p>Twitter, AirBnB, Tinder, Yahoo, Adobe, Hulu, Amazon&#8230;&#8203;</p></div>
<div class="paragraph"><p>(<a href="https://en.wikipedia.org/wiki/Redis#Users" class="bare">https://en.wikipedia.org/wiki/Redis#Users</a>)</p></div></div></section>
<section id="_история"><h2>История</h2><div class="slide-content"><div class="ulist"><ul><li><p>2009 год: Salvatore Sanfilippo aka antirez</p></li><li><p>Tcl &#8594; C (но тесты написаны на Tcl)</p></li><li><p>2015: Redis Labs</p></li><li><p>Июнь 2020: Salvatore Sanfilippo перестал быть мейнтейнером</p></li><li><p>Март 2024: проприетарная лицензия, форк Valkey</p></li></ul></div></div></section>
<section id="_для_чего_используют"><h2>Для чего используют?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Кэширование!</p></li><li><p>Координация работы микросервисов (в широком смысле слова)</p></li><li><p>Для сравнения: Default Max Connections</p><div class="ulist"><ul><li><p>PostgreSQL: 100</p></li><li><p>Redis: 10000</p></li></ul></div></li></ul></div></div></section>
<section id="_за_счёт_чего_работает_так_быстро"><h2>За счёт чего работает так быстро?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Весь датасет в памяти.</p></li><li><p>На диск сбрасывается снапшот или лог транзакций.</p></li><li><p>По умолчанию ~ 1 раз в 2 секунды.</p></li><li><p><strong>Аварийно завершившись, может потерять немного данных.</strong></p></li></ul></div></div></section>
<section id="_чем_ещё_хорош"><h2>Чем ещё хорош?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Salvatore любит вероятностные алгоритмы</p></li><li><p>Вероятностный алгоритм cache expiration</p></li><li><p>HyperLogLog</p></li></ul></div></div></section>
<section id="_redisоднопоточная_система"><h2>Redis&#8201;&#8212;&#8201;однопоточная система</h2><div class="slide-content"><div class="ulist"><ul><li><p>Изменения данных происходят в одном потоке, одно за другим.</p></li><li><p>За счёт этого&#8201;&#8212;&#8201;изоляция и атомарность операций.</p></li></ul></div></div></section>
<section id="_почему_так_популярен"><h2>Почему так популярен?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Простота освоения / концептуальная простота</p></li><li><p>Производительность</p></li><li><p>Очень богатая функциональность: caches, queues, atomic counters, distributed locks, semaphores, Bloom filters, etc etc etc</p></li><li><p>Почти что база данных!</p></li></ul></div>
<div class="imageblock"><img src="images/sak.jpg" alt="sak" width="20%"></div></div></section>
<section id="_база_данных_ли_это_размер_проекта"><h2>База данных ли это? Размер проекта</h2><div class="slide-content"><div class="ulist"><ul><li><p>Написан на C (173 KLOC of C code as of Apr 2024 + 46 KLOC Tcl/Tk)</p></li></ul></div>
<div class="imageblock"><img src="images/loc.png" alt="loc"></div></div></section>
<section id="_acid"><h2>ACID</h2><div class="slide-content"><div class="imageblock"><img src="images/acid.png" alt="acid"></div></div></section>
<section id="_redis_и_acid"><h2>Redis и ACID</h2><div class="slide-content"><div class="ulist"><ul><li><p><strong>Atomicity:</strong></p><div class="ulist"><ul><li><p>Есть много атомарных операций (<a href="https://redis.io/docs/latest/commands/getset"><code>GETSET</code></a>, <a href="https://redis.io/docs/latest/commands/setnx"><code>SETNX</code></a> и т. п.)</p></li><li><p>Есть транзакции записи, выполняемые "одним куском" (но rollback-а в середине нет, поэтому если ошибка, то ¯\_(ツ)_/¯)</p></li></ul></div></li></ul></div></div></section>
<section id="_redis_и_acid_2"><h2>Redis и ACID</h2><div class="slide-content"><div class="ulist"><ul><li><p><strong>Consistency:</strong></p><div class="ulist"><ul><li><p>Гарантий целостности, обычно предоставляемых базами данных, нет.</p></li><li><p>Роллбеки не поддерживаются, но есть optimistic lock, не позволяющий менять данные в случае потерянных обновлений.</p></li></ul></div></li></ul></div></div></section>
<section id="_redis_и_acid_3"><h2>Redis и ACID</h2><div class="slide-content"><div class="ulist"><ul><li><p><strong>Isolation:</strong></p><div class="ulist"><ul><li><p>Все записи и транзакции происходят по очереди, в одном потоке, изоляция полная.</p></li></ul></div></li></ul></div></div></section>
<section id="_redis_и_acid_4"><h2>Redis и ACID</h2><div class="slide-content"><div class="ulist"><ul><li><p><strong>Durability:</strong></p><div class="ulist"><ul><li><p>На диск данные периодически сохраняются, но между сохранениями могут немного потеряться ¯\_(ツ)_/¯</p></li></ul></div></li></ul></div></div></section>
<section id="_ограничения"><h2>Ограничения</h2><div class="slide-content"><div class="ulist"><ul><li><p>Распределённый режим не является изначальной задумкой</p></li><li><p>Есть репликация master-slave, как у классических БД</p></li><li><p>Возможна кластеризация, но с ограничениями</p></li><li><p>Не fault-tolerant система, вроде Zookeeper/etcd или Cassandra!</p></li></ul></div></div></section>
<section id="_как_попробовать"><h2>Как попробовать?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Локально в докере</p><div class="ulist"><ul><li><p><code>docker run --name some-redis -d redis</code></p></li><li><p><code>docker exec -it some-redis redis-cli</code></p></li></ul></div></li><li><p>Песочница (только для некоторых команд)</p><div class="ulist"><ul><li><p><a href="https://try.redis.io/" class="bare">https://try.redis.io/</a></p></li></ul></div></li><li><p>Linux: <code>sudo snap install redis</code></p></li><li><p>Windows: <strong>не работает в принципе</strong></p></li></ul></div></div></section>
<section id="_логическая_структура_базы_данных_и_ключи"><h2>Логическая структура: базы данных и ключи</h2><div class="slide-content"><div class="ulist"><ul><li><p>База данных выбирается командой <a href="https://redis.io/docs/latest/commands/select"><code>SELECT</code></a></p></li><li><p>Независимые пространства имён ключей</p></li></ul></div>
<div class="imageblock"><img src="images/diag-graphviz-md5-4840bcf49a799ee31cbdd01bbca28f86.png" alt="Diagram"></div></div></section>
<section id="_операции_над_базой_данных"><h2>Операции над базой данных</h2><div class="slide-content"><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/flushdb"><code>FLUSHDB</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/flushall"><code>FLUSHALL</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/keys"><code>KEYS pattern</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/randomkey"><code>RANDOMKEY</code></a></p></li></ul></div></div></section>
<section id="_скалярные_значения"><h2>Скалярные значения</h2><div class="slide-content"><div class="imageblock"><img src="images/diag-graphviz-md5-53bb67b9c0ddd2dc4e0512907143fd4d.png" alt="Diagram"></div>
<table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Общие</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Строки</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Числа</p></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/set"><code>SET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/get"><code>GET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/del"><code>DEL</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/copy"><code>COPY</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/rename"><code>RENAME</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/exists"><code>EXISTS</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/append"><code>APPEND</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/setrange"><code>SETRANGE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/getrange"><code>GETRANGE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/strlen"><code>STRLEN</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/stralgo"><code>STRALGO LCS [KEYS|STRINGS</a></code>]</p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/incr"><code>INCR</code></a> / <a href="https://redis.io/docs/latest/commands/decr"><code>DECR</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/incrby"><code>INCRBY</code></a> / <a href="https://redis.io/docs/latest/commands/decrby"><code>DECRBY</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/incrbyfloat"><code>INCRBYFLOAT</code></a></p></li></ul></div></div></td></tr></table></div></section>
<section id="_комбинированные_атомарные_операции"><h2>Комбинированные атомарные операции</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Комбинированные</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Мультиоперации</p></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/getdel"><code>GETDEL</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/getset"><code>GETSET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/setnx"><code>SETNX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/renamenx"><code>RENAMENX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/set"><code>SET key value [NX|XX] [GET]</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/mget"><code>MGET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/mset"><code>MSET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/msetnx"><code>MSETNX</code></a></p></li></ul></div></div></td></tr></table></div></section>
<section id="_cas_операции_на_одном_ключе_нет"><h2>CAS-операции на одном ключе нет</h2><div class="slide-content"><div class="imageblock"><img src="images/nocas.png" alt="nocas"></div>
<div class="paragraph"><p>&#8230;&#8203;но вообще механизм "оптимистичной блокировки есть" на базе <code>WATCH</code>..<code>MULTI</code>..<code>EXEC</code>, о чем речь пойдёт далее</p></div></div></section>
<section id="_keys_expiration"><h2>Keys Expiration</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Установить</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Узнать</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Сбросить</p></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/expire"><code>EXPIRE</code></a> / <a href="https://redis.io/docs/latest/commands/pexpire"><code>PEXPIRE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/expireat"><code>EXPIREAT</code></a> / <a href="https://redis.io/docs/latest/commands/pexpireat"><code>PEXPIREAT</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/setex"><code>SETEX</code></a> / <a href="https://redis.io/docs/latest/commands/psetex"><code>PSETEX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/getex"><code>GETEX</code></a> / <a href="https://redis.io/docs/latest/commands/pgetex"><code>PGETEX</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/ttl"><code>TTL</code></a> / <a href="https://redis.io/docs/latest/commands/pttl"><code>PTTL</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/expiretime"><code>EXPIRETIME</code></a> / <a href="https://redis.io/docs/latest/commands/pexpiretime"><code>PEXPIRETIME</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/persist"><code>PERSIST</code></a></p></li></ul></div></div></td></tr></table></div></section>
<section id="_как_работает_expiration"><h2>Как работает expiration</h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>This is what Redis does 10 times per second:</p></div>
<div class="paragraph"><p>Test 20 random keys from the set of keys with an associated expire.
Delete all the keys found expired.
If more than 25% of keys were expired, start again from step 1.</p></div>
<div class="paragraph"><p>[&#8230;&#8203;]This means that at any given moment the maximum amount of keys already expired that are using memory is at max equal to max amount of write operations per second divided by 4.</p></div></blockquote></div></div></section>
<section id="_пример_rate_limiter"><h2>Пример: Rate Limiter</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>current = GET(ip)
IF current != NULL AND current &gt; 10 THEN
    ERROR "too many requests per second"
ELSE
    value = INCR(ip)
    IF value == 1 THEN
        EXPIRE(ip,1) //&lt;---если не выполним, будет плохо!
    END
    PERFORM_API_CALL()
END</code></pre></div></div></div></section>
<section id="_пример_rate_limiter_2"><h2>Пример: Rate Limiter</h2><div class="slide-content"><div class="paragraph"><p>Используя <a href="https://redis.io/docs/latest/commands/eval"><code>EVAL</code></a>, запускать атомарный Lua-скрипт на втором шаге:</p></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="lua"><span style="color: #000000;font-weight: bold">local</span> <span style="background-color: #f8f8f8">current</span>
<span style="background-color: #f8f8f8">current</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">redis</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">call</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">"incr"</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">KEYS</span><span style="background-color: #f8f8f8">[</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">])</span>
<span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">current</span> <span style="color: #000000;font-weight: bold">==</span> <span style="color: #009999">1</span> <span style="color: #000000;font-weight: bold">then</span>
    <span style="background-color: #f8f8f8">redis</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">call</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">"expire"</span><span style="background-color: #f8f8f8">,</span><span style="background-color: #f8f8f8">KEYS</span><span style="background-color: #f8f8f8">[</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">],</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">)</span>
<span style="color: #000000;font-weight: bold">end</span></code></pre></div></div></div></section>
<section id="_bitmaps"><h2>Bitmaps</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:20%"><col style="width:80%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/setbit"><code>SETBIT</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/getit"><code>GETIT</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/bitop"><code>BITOP</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/bitcount"><code>BITCOUNT</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="imageblock"><img src="images/diag-graphviz-md5-540bd3d3adbce985df5e10c846900fd2.png" alt="Diagram"></div></div></td></tr></table></div></section>
<section id="_bloom_filter"><h2>Bloom filter</h2><div class="slide-content"><div class="imageblock"><img src="images/bloom_filter.svg" alt="bloom filter" width="100%"></div></div></section>
<section id="_hyperloglog"><h2>HyperLogLog</h2><div class="slide-content"><div class="paragraph"><p>Подсчёт уникальных значений без сохранения самих значений</p></div>
<div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/pfadd"><code>PFADD</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/pfcount"><code>PFCOUNT</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/pfmerge"><code>PFMERGE</code></a></p></li></ul></div>
<div class="paragraph"><p>(можно передавать между системами через <a href="https://redis.io/docs/latest/commands/dump"><code>DUMP</code></a> / <a href="https://redis.io/docs/latest/commands/restore"><code>RESTORE</code></a>)</p></div></div></section>
<section id="_hash_fields"><h2>Hash fields</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="imageblock"><img src="images/diag-graphviz-md5-fb01162b3dc848408c4b6fd42d028007.png" alt="Diagram"></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/hset"><code>HSET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hget"><code>HGET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hdel"><code>HDEL</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hexists"><code>HEXISTS</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hincrby"><code>HINCRBY</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hincrbyfloat"><code>HINCRBYFLOAT</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hlen"><code>HLEN</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hrandfield"><code>HRANDFIELD</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/hmget"><code>HMGET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hmset"><code>HMSET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hkeys"><code>HKEYS</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hvals"><code>HVALS</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hgetall"><code>HGETALL</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hsetnx"><code>HSETNX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/hstrlen"><code>HSTRLEN</code></a></p></li></ul></div></div></td></tr></table>
<div class="paragraph"><p>NB: expiration работает только на уровне структуры целиком, а не её отдельных ключей.</p></div></div></section>
<section id="_lists"><h2>Lists</h2><div class="slide-content"><div class="imageblock"><img src="images/diag-graphviz-md5-03c28d71d187e66bffcbe402711d3184.png" alt="Diagram"></div>
<table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>O(N) (N - длина списка)</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>O(1)</p></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/lindex"><code>LINDEX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/lrange"><code>LRANGE</code></a> (весь список: <code>LRANGE my_list 0 -1</code>)</p></li><li><p><a href="https://redis.io/docs/latest/commands/linsert"><code>LINSERT</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/lpos"><code>LPOS</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/lrem"><code>LREM</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/lset"><code>LSET</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/ltrim"><code>LTRIM</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/llen"><code>LLEN</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/lpop"><code>LPOP</code></a> / <a href="https://redis.io/docs/latest/commands/rpop"><code>RPOP</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/lpush"><code>LPUSH</code></a> / <a href="https://redis.io/docs/latest/commands/rpush"><code>RPUSH</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/lpushx"><code>LPUSHX</code></a> / <a href="https://redis.io/docs/latest/commands/rpushx"><code>RPUSHX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/lmove"><code>LMOVE</code></a> (перемещение между разными списками)</p></li></ul></div></div></td></tr></table></div></section>
<section id="_блокирующие_очереди"><h2>Блокирующие очереди</h2><div class="slide-content"><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/blpop"><code>BLPOP</code></a> / <a href="https://redis.io/docs/latest/commands/brpop"><code>BRPOP</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/brpoplpush"><code>BRPOPLPUSH</code></a> (deprecated в пользу <a href="https://redis.io/docs/latest/commands/blmove"><code>BLMOVE</code></a>)</p></li><li><p><a href="https://redis.io/docs/latest/commands/blmove"><code>BLMOVE</code></a></p></li></ul></div></div></section>
<section id="_надёжная_очередь"><h2>Надёжная очередь</h2><div class="slide-content"><div class="paragraph"><p><a href="https://redis.io/docs/latest/commands/blpoprpush"><code>BLPOPRPUSH</code></a> или <a href="https://redis.io/docs/latest/commands/blmove"><code>BLMOVE</code></a></p></div>
<div class="imageblock"><img src="images/diag-graphviz-md5-dcc9bec72c51164011471c90eb449df7.png" alt="Diagram"></div>
<div class="imageblock"><img src="images/diag-graphviz-md5-19be29b08308a2c54a0dcff2a557ac45.png" alt="Diagram"></div>
<div class="ulist"><ul><li><p>В отличие от <code>BLPOP</code>, элемент не пропадает из Redis, и в случае, если слишком долго висит "in process", его можно повторно пытаться обработать.</p></li></ul></div></div></section>
<section id="_sets"><h2>Sets</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:25%"><col style="width:25%"><col style="width:25%"><col style="width:25%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Один элемент</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Случайный<br>
элемент</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Множества</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Перемещение между множествами</p></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/sadd"><code>SADD</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/srem"><code>SREM</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/scard"><code>SCARD</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/smembers"><code>SMEMBERS</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/smismember"><code>SMISMEMBER</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/spop"><code>SPOP</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/srandmember"><code>SRANDMEMBER</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/sdiff"><code>SDIFF</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/sinter"><code>SINTER</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/sintercard"><code>SINTERCARD</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/sunion"><code>SUNION</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/smove"><code>SMOVE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/sdiffstore"><code>SDIFFSTORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/sinterstore"><code>SINTERSTORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/sunionstore"><code>SUNIONSTORE</code></a></p></li></ul></div></div></td></tr></table></div></section>
<section id="_zsets_sorted_sets"><h2>ZSets (sorted sets)</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="imageblock"><img src="images/diag-graphviz-md5-8e2a7c74e56e97d38316ec11c2d504b0.png" alt="Diagram"></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p>members&#8201;&#8212;&#8201;уникальны</p></li><li><p>отсортированы по score</p></li><li><p>если score одинаков, то сортируются лексикографически</p></li></ul></div></div></td></tr></table></div></section>
<section id="_zset_commands"><h2>ZSet commands</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/bzmpop"><code>BZMPOP</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/bzpopmax"><code>BZPOPMAX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/bzpopmin"><code>BZPOPMIN</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zadd"><code>ZADD</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zcard"><code>ZCARD</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zcount"><code>ZCOUNT</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zdiff"><code>ZDIFF</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zdiffstore"><code>ZDIFFSTORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zincrby"><code>ZINCRBY</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zinter"><code>ZINTER</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zintercard"><code>ZINTERCARD</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/zinterstore"><code>ZINTERSTORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zlexcount"><code>ZLEXCOUNT</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zmpop"><code>ZMPOP</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zmscore"><code>ZMSCORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zpopmax"><code>ZPOPMAX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zpopmin"><code>ZPOPMIN</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrandmember"><code>ZRANDMEMBER</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrange"><code>ZRANGE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrangebylex"><code>ZRANGEBYLEX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrangebyscore"><code>ZRANGEBYSCORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrangestore"><code>ZRANGESTORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrank"><code>ZRANK</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/zrem"><code>ZREM</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zremrangebylex"><code>ZREMRANGEBYLEX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zremrangebyrank"><code>ZREMRANGEBYRANK</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zremrangebyscore"><code>ZREMRANGEBYSCORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrevrange"><code>ZREVRANGE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrevrangebylex"><code>ZREVRANGEBYLEX</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrevrangebyscore"><code>ZREVRANGEBYSCORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zrevrank"><code>ZREVRANK</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zscan"><code>ZSCAN</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zscore"><code>ZSCORE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zunion"><code>ZUNION</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/zunionstore"><code>ZUNIONSTORE</code></a></p></li></ul></div></div></td></tr></table></div></section>
<section id="_zsets_semaphore"><h2>ZSets: Semaphore</h2><div class="slide-content"><div class="paragraph"><p>Ограничитель числа параллельно выполяющихся процессов</p></div>
<div class="imageblock"><img src="images/diag-graphviz-md5-00036b4097a79a014418a8f2f7bb8a51.png" alt="Diagram"></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>rank = INCR counter
ZADD semaphore my_id rank
if ZRANK semaphore my_id &lt; limit
  //we can move on
else
  //we'll have to wait
  ZREM semaphore my_id</code></pre></div></div></div></section>
<section id="_pubsub"><h2>PUB/SUB</h2><div class="slide-content"><div class="paragraph"><p>Обмен сообщениями</p></div>
<table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Подписка на каналы</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Подписка по паттернам</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Метаданные</p></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/publish"><code>PUBLISH</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/subscribe"><code>SUBSCRIBE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/unsubscribe"><code>UNSUBSCRIBE</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/psubscribe"><code>PSUBSCRIBE</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/punsubscribe"><code>PUNSUBSCRIBE</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><code>PUBSUB CHANNELS</code></p></li><li><p><code>PUBSUB NUMPAT</code></p></li><li><p><code>PUBSUB NUMSUB</code></p></li></ul></div></div></td></tr></table></div></section>
<section id="_keyspace_notifications"><h2>Keyspace notifications</h2><div class="slide-content"><div class="paragraph"><p><a href="https://redis.io/docs/latest/develop/use/keyspace-notifications/" class="bare">https://redis.io/docs/latest/develop/use/keyspace-notifications/</a></p></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>config set notify-keyspace-events KEA
psubscribe '*'</code></pre></div></div></div></section>
<section id="_как_перехватывать_все_команды"><h2>Как перехватывать все команды</h2><div class="slide-content"><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/monitor"><code>MONITOR</code></a></p></li></ul></div>
<div class="paragraph"><p>Бывает необходима, чтобы посмотреть, что происходит на сервере и оптимизировать поступающие команды</p></div></div></section>
<section id="_streams"><h2>Streams</h2><div class="slide-content"><div class="imageblock"><img src="images/streams-2.png" alt="streams 2"></div><div class="title"><a href="https://redis.com/redis-enterprise/data-structures/" class="bare">https://redis.com/redis-enterprise/data-structures/</a></div></div></section>
<section id="_streams_2"><h2>Streams</h2><div class="slide-content"><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/xadd"><code>XADD</code></a> добавляет новую запись в поток.</p></li><li><p><a href="https://redis.io/docs/latest/commands/xread"><code>XREAD</code></a> считывает одну или несколько записей, начиная с заданной позиции и продвигаясь вперед во времени.</p></li><li><p><a href="https://redis.io/docs/latest/commands/xrange"><code>XRANGE</code></a> возвращает диапазон записей между двумя предоставленными идентификаторами записей.</p></li><li><p><a href="https://redis.io/docs/latest/commands/xlen"><code>XLEN</code></a> возвращает длину стрима.</p></li></ul></div>
<div class="paragraph"><p>Описание: <a href="https://redis.io/topics/streams-intro" class="bare">https://redis.io/topics/streams-intro</a></p></div></div></section>
<section id="_geo"><h2>Geo</h2><div class="slide-content"><div class="paragraph"><p>Геопространственный индекс с шарообразной моделью Земли</p></div>
<table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:40%"><col style="width:60%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="imageblock"><img src="images/earth_model.svg" alt="earth model"></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/geoadd"><code>GEOADD</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/geodist"><code>GEODIST</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/geohash"><code>GEOHASH</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/geopos"><code>GEOPOS</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/georadius"><code>GEORADIUS</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/georadiusbymember"><code>GEORADIUSBYMEMBER</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/geosearch"><code>GEOSEARCH</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/geosearchstore"><code>GEOSEARCHSTORE</code></a></p></li></ul></div></div></td></tr></table></div></section>
<section id="_geo_2"><h2>Geo</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>redis&gt;  GEOADD Sicily
  13.361389 38.115556 "Palermo"
  15.087269 37.502669 "Catania"
(integer) 2

redis&gt;  GEODIST Sicily Palermo Catania
"166274.1516"

redis&gt;  GEORADIUS Sicily 15 37 100 km
1) "Catania"

redis&gt;  GEORADIUS Sicily 15 37 200 km
1) "Palermo"
2) "Catania"</code></pre></div></div></div></section>
<section id="_скриптование_на_lua"><h2>Скриптование на Lua</h2><div class="slide-content"><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/eval"><code>EVAL</code></a></p></li><li><p><code>SCRIPT LOAD</code></p></li><li><p><code>SCRIPT EXISTS</code></p></li><li><p><a href="https://redis.io/docs/latest/commands/evalsha"><code>EVALSHA</code></a></p></li></ul></div></div></section>
<section id="_скриптование_на_lua_примеры"><h2>Скриптование на Lua: примеры</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>EVAL "return redis.call('set','foo','bar')" 0

EVAL "return redis.call('set',KEYS[1],'bar')" 1 foo

SCRIPT LOAD "return redis.call('set','foo','bar')"
"2fa2b029f72572e803ff55a09b1282699aecae6a"

EVALSHA 2fa2b029f72572e803ff55a09b1282699aecae6a 0</code></pre></div></div></div></section>
<section id="_транзакции"><h2>Транзакции</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Операции</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Выполнение транзакции</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Отмена выполнения</p></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/multi"><code>MULTI</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/exec"><code>EXEC</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/discard"><code>DISCARD</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>&gt; MULTI
OK
&gt; INCR foo
QUEUED
&gt; INCR bar
QUEUED
&gt; EXEC
1) (integer) 1
2) (integer) 1</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>&gt; SET foo 1
OK
&gt; MULTI
OK
&gt; INCR foo
QUEUED
&gt; DISCARD
OK
&gt; GET foo
"1"</code></pre></div></div></div></td></tr></table></div></section>
<section id="_оптимистичные_блокировки"><h2>Оптимистичные блокировки</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Операции</p></div></div></td><td class="tableblock halign-left valign-top"><div><div class="paragraph"><p>Пример</p></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p><a href="https://redis.io/docs/latest/commands/watch"><code>WATCH</code></a></p></li><li><p><a href="https://redis.io/docs/latest/commands/unwatch"><code>UNWATCH</code></a></p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>WATCH mykey
val = GET mykey
val = function(val)
MULTI
SET mykey $val
EXEC</code></pre></div></div></div></td></tr></table></div></section>
<section id="_lock_захват_блокировки"><h2>Lock: захват блокировки</h2><div class="slide-content"><div class="paragraph"><p>В чём проблема?</p></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>if not EXISTS lockname
   SET lockname my_id
else
   //lock is acquired, let's try another time...</code></pre></div></div>
<div class="paragraph fragment"><p>Между вызовами <a href="https://redis.io/docs/latest/commands/exists"><code>EXISTS</code></a> и <a href="https://redis.io/docs/latest/commands/set"><code>SET</code></a> кто-то мог захватить блокировку.</p></div></div></section>
<section id="_lock_захват_блокировки_2"><h2>Lock: захват блокировки</h2><div class="slide-content"><div class="paragraph"><p>За время, меньшее чем <code>timeout</code>, мы должны что-то сделать, иначе блокировка от нас отвалится!</p></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>if SETNX lockname
   EXPIRE lockname NX
else
   //lock is acquired, let's try another time...</code></pre></div></div>
<div class="paragraph"><p>Но в чём теперь проблема?</p></div></div></section>
<section id="_lock_захват_блокировки_3"><h2>Lock: захват блокировки</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>my_id = new guid
//or use MULTI..EXEC
if SET lockname my_id EX timeout NX
  //success!
else
  //lock is acquired, let's try another time...</code></pre></div></div></div></section>
<section id="_lock_отпускание_блокировки"><h2>Lock: отпускание блокировки</h2><div class="slide-content"><div class="paragraph"><p>В чём проблема?</p></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>DEL lockname</code></pre></div></div>
<div class="paragraph fragment"><p>Пока мы работали, мы могли не заметить что блокировку у нас перехватили по таймауту.</p></div></div></section>
<section id="_lock_отпускание_блокировки_2"><h2>Lock: отпускание блокировки</h2><div class="slide-content"><div class="paragraph"><p>В чём проблема?</p></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>if GET lockname == my_id
    DEL lockname</code></pre></div></div>
<div class="paragraph fragment"><p>Перехват по таймауту мог произойти между вызовами <a href="https://redis.io/docs/latest/commands/get"><code>GET</code></a> и <a href="https://redis.io/docs/latest/commands/del"><code>del</code></a>.</p></div></div></section>
<section id="_lock_отпускание_блокировки_3"><h2>Lock: отпускание блокировки</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code>WATCH lockname
if GET lockname == my_id
  //we're still holding the lock!
  MULTI
  //don't delete it if someone acquired the lock this moment...
  DEL lockname
  EXEC
  return 'lock released successfully'

return 'someone acquired our lock while we were busy...'</code></pre></div></div>
<div class="paragraph"><p>(В действительности, это можно провернуть в Lua-скрипте простым if-ом без <code>WATCH/MULTI/EXEC</code>)</p></div></div></section>
<section id="_библиотеки_для_redis_connectivity"><h2>Библиотеки для Redis Connectivity</h2><div class="slide-content"><div class="ulist"><ul><li><p>Существуют для всех основных языков и платформ (C#/.NET, Go, Java, Node.js, Python)</p></li><li><p><a href="https://redis.io/docs/latest/develop/connect/" class="bare">https://redis.io/docs/latest/develop/connect/</a></p></li></ul></div></div></section>
<section id="_redis_и_java"><h2>Redis и Java</h2><div class="slide-content"><div class="ulist"><ul><li><p>Jedis&#8201;&#8212;&#8201;для синхронного доступа</p></li><li><p>Lettuce&#8201;&#8212;&#8201;для асинхронного доступа / реактивных приложений</p></li><li><p>Redisson&#8201;&#8212;&#8201;для типо-безопасной, объектно-ориентированной работы, обладает большим количетвом собственных "строительных блоков", поддерживает как синхронные, так и асинхронные API</p></li></ul></div></div></section>
<section id="_возможности_redisson"><h2>Возможности Redisson</h2><div class="slide-content"><div class="ulist"><ul><li><p><code>AtomicLong</code>/<code>AtomicDouble</code>&#8201;&#8212;&#8201;ведут себя как Java atomics, но только в распределённой среде</p></li><li><p><code>BitSet</code>, <code>BloomFilter</code>, <code>HyperLogLog</code></p></li><li><p><code>Topic</code></p></li></ul></div></div></section>
<section id="_objectholder_типовая_безопасность"><h2><code>ObjectHolder</code>: типовая безопасность</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">RBucket</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #445588;font-weight: bold">AnyObject</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">bucket</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">redisson</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getBucket</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"anyObject"</span><span style="color: #000000;font-weight: bold">);</span>

<span style="background-color: #f8f8f8">bucket</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">set</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">AnyObject</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">1</span><span style="color: #000000;font-weight: bold">));</span>
<span style="color: #445588;font-weight: bold">AnyObject</span> <span style="background-color: #f8f8f8">obj</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">bucket</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">get</span><span style="color: #000000;font-weight: bold">();</span>

<span style="background-color: #f8f8f8">bucket</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">trySet</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">AnyObject</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">3</span><span style="color: #000000;font-weight: bold">));</span>
<span style="background-color: #f8f8f8">bucket</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">compareAndSet</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">AnyObject</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">4</span><span style="color: #000000;font-weight: bold">),</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">AnyObject</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">5</span><span style="color: #000000;font-weight: bold">));</span>
<span style="background-color: #f8f8f8">bucket</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getAndSet</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">AnyObject</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">6</span><span style="color: #000000;font-weight: bold">));</span></code></pre></div></div>
<div class="paragraph"><p>"Под капотом" Redisson сериализует объект в строку, также используется Lua-скриптинг</p></div></div></section>
<section id="_map"><h2>Map</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">RMap</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #445588;font-weight: bold">String</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">SomeObject</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">map</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">redisson</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getMap</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"anyMap"</span><span style="color: #000000;font-weight: bold">);</span>
<span style="color: #445588;font-weight: bold">SomeObject</span> <span style="background-color: #f8f8f8">prevObject</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">map</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">put</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"123"</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">SomeObject</span><span style="color: #000000;font-weight: bold">());</span>
<span style="color: #445588;font-weight: bold">SomeObject</span> <span style="background-color: #f8f8f8">currentObject</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">map</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">putIfAbsent</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"323"</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">SomeObject</span><span style="color: #000000;font-weight: bold">());</span>
<span style="color: #445588;font-weight: bold">SomeObject</span> <span style="background-color: #f8f8f8">obj</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">map</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">remove</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"123"</span><span style="color: #000000;font-weight: bold">);</span></code></pre></div></div></div></section>
<section id="_redisson_распределенные_блокировки_и_синхронизаторы"><h2>Redisson: распределенные блокировки и синхронизаторы</h2><div class="slide-content"><div class="ulist"><ul><li><p>Lock</p></li><li><p>Fair Lock</p></li><li><p>MultiLock</p></li><li><p>RedLock</p></li><li><p>ReadWriteLock</p></li><li><p>Semaphore</p></li><li><p>PermitExpirableSemaphore</p></li><li><p>CountDownLatch</p></li><li><p>Spin Lock</p></li><li><p>Fenced Lock</p></li></ul></div></div></section>
<section id="_как_тестируют_приложения_с_redis"><h2>Как тестируют приложения с Redis?</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:40%"><col style="width:10%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-right valign-middle"><div><div class="paragraph"><p><strong>Моки</strong></p></div></div></td><td class="tableblock halign-center valign-middle"><div><div class="imageblock"><img src="images/vs.svg" alt="vs"></div></div></td><td class="tableblock halign-left valign-middle"><div><div class="paragraph"><p><strong>Testcontainers</strong></p></div></div></td></tr></table></div></section>
<section id="_testcontainers_запуск_настоящего_redis_для_выполнения_теста"><h2>Testcontainers: запуск "настоящего" Redis для выполнения теста</h2><div class="slide-content"><div class="imageblock"><img src="images/testcontainers_transparent.png" alt="testcontainers transparent" width="30%"></div>
<div class="paragraph"><p>Redis является одним из самых первых примеров для Testcontainers</p></div></div></section>
<section id="_testcontainers"><h2>Testcontainers</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #3c5d5d;font-weight: bold">@Testcontainers</span>
<span style="color: #000000;font-weight: bold">public</span> <span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">RedisBackedCacheIntTest</span> <span style="color: #000000;font-weight: bold">{</span>
  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #445588;font-weight: bold">RedisBackedCache</span> <span style="background-color: #f8f8f8">underTest</span><span style="color: #000000;font-weight: bold">;</span>
  <span style="color: #3c5d5d;font-weight: bold">@Container</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">GenericContainer</span> <span style="background-color: #f8f8f8">redis</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">GenericContainer</span><span style="color: #000000;font-weight: bold">(</span>
    <span style="color: #445588;font-weight: bold">DockerImageName</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">parse</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"redis:5.0.3-alpine"</span><span style="color: #000000;font-weight: bold">)).</span><span style="color: #008080">withExposedPorts</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">6379</span><span style="color: #000000;font-weight: bold">);</span>
  <span style="color: #3c5d5d;font-weight: bold">@BeforeEach</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">setUp</span><span style="color: #000000;font-weight: bold">()</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #445588;font-weight: bold">String</span> <span style="background-color: #f8f8f8">address</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">redis</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getHost</span><span style="color: #000000;font-weight: bold">();</span>
    <span style="color: #445588;font-weight: bold">Integer</span> <span style="background-color: #f8f8f8">port</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">redis</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getFirstMappedPort</span><span style="color: #000000;font-weight: bold">();</span>
    <span style="color: #999988;font-style: italic">// Now we have an address and port for Redis</span>
    <span style="background-color: #f8f8f8">underTest</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">RedisBackedCache</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">address</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">port</span><span style="color: #000000;font-weight: bold">);</span>
  <span style="color: #000000;font-weight: bold">}</span>
  <span style="color: #3c5d5d;font-weight: bold">@Test</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">testSomething</span><span style="color: #000000;font-weight: bold">()</span> <span style="color: #000000;font-weight: bold">{</span> <span style="color: #000000;font-weight: bold">....</span> <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_моки_redis_на_разных_языках"><h2>Моки Redis на разных языках</h2><div class="slide-content"><div class="ulist"><ul><li><p>Python: <a href="https://github.com/cunla/fakeredis-py" class="bare">https://github.com/cunla/fakeredis-py</a></p></li><li><p>NodeJS: <a href="https://github.com/yeahoffline/redis-mock" class="bare">https://github.com/yeahoffline/redis-mock</a></p></li><li><p>Java: <a href="https://github.com/fppt/jedis-mock" class="bare">https://github.com/fppt/jedis-mock</a></p></li></ul></div></div></section>
<section id="_зачем_мок_если_есть_testcontainers"><h2>Зачем мок, если есть Testcontainers?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Still, Testcontainers require Docker and some time to download and run the container. Jedis-Mock requires Java.</p></li><li><p>Sometimes we want to manage the reply:</p><div class="ulist"><ul><li><p>imitate a system or network failure</p></li><li><p>give a deterministic answer for non-deterministic query</p></li></ul></div></li></ul></div></div></section>
<section id="_зачем_мок_если_есть_testcontainers_2"><h2>Зачем мок, если есть Testcontainers?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Иногда нужен "прозрачный ящик" для тестирования, т. е. проверка запросов и подмена ответов</p></li></ul></div>
<div class="imageblock"><img src="images/diag-plantuml-md5-f8bb7585cd388431fb03365344ee2f23.png" alt="Diagram"></div></div></section>
<section id="_jedismock_history"><h2>JedisMock history</h2><div class="slide-content"><div class="ulist"><ul><li><p>2017: Filipe Peliz Pinto Teixeira forked an abandoned POC repository.</p></li><li><p>2019: I tried to use it in my project and soon gave up</p></li><li><p>2021-now: actively developed by MIPT students under my supervision</p></li><li><p>2023: I have full rights for maintaing &amp; publishig new versions</p></li></ul></div>
<div class="imageblock"><img src="images/redis-maintainers.jpg" alt="redis maintainers" width="40%"></div></div></section>
<section id="_jedismock_кто_использует"><h2>JedisMock: кто использует?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Известные нам зависимости: Slack API client, dropwizard.io</p></li></ul></div>
<div class="imageblock"><img src="images/users.png" alt="users"></div></div></section>
<section id="_jedismock_кто_использует_2"><h2>JedisMock: кто использует?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Стабильный приток новых багрепортов и запросов на доработку.</p></li><li><p>150 звёзд на GitHub&#8217;е&#8201;&#8212;&#8201;кстати, поставьте, пожалуйста, звезду!</p></li></ul></div>
<div class="imageblock"><img src="images/issues.png" alt="issues"></div></div></section>
<section id="_jedismock_идея"><h2>JedisMock: идея</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p><span class="image"><img src="images/sak.jpg" alt="sak" width="300"></span></p></div></div></td><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p><span class="image"><img src="images/sak.jpg" alt="sak" width="300"></span></p></div></div></td></tr><tr><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p><strong>Redis data type</strong></p></div></div></td><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p><strong>Java data type</strong></p></div></div></td></tr><tr><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>HMAP</p></div></div></td><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>HashMap</p></div></div></td></tr><tr><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>LIST</p></div></div></td><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>ArrayList</p></div></div></td></tr><tr><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>SET</p></div></div></td><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>HashSet</p></div></div></td></tr><tr><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>ZSET</p></div></div></td><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>TreeSet+HashMap</p></div></div></td></tr><tr><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>Bit operations</p></div></div></td><td class="tableblock halign-center valign-top"><div><div class="paragraph"><p>BitSet</p></div></div></td></tr></table></div></section>
<section id="_jedismock_networkingthreading"><h2>JedisMock: networking&amp;threading</h2><div class="slide-content"><div class="ulist"><ul><li><p><code>java.net.ServerSocket</code></p></li><li><p>Каждый входящий клиент получает по треду из <code>CachedThreadPool</code></p></li><li><p>Все треды синхронизируются по единственному lock-у перед внсением изменений</p></li><li><p>Блокирующие операции (такие как <code>BLPOP</code>) используют <code>wait</code>/<code>notify</code></p></li></ul></div></div></section>
<section id="_как_мы_делаем_его_похожим_на_настоящий_redis"><h2>Как мы делаем его похожим на настоящий  Redis?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Redis: 237 команд различной популярности и важности  (принцип Парето 80/20 тут работает)</p></li><li><p>Jedis-mock: поддерживает 153 команды  (64% и это число растёт)</p></li></ul></div>
<div class="imageblock"><img src="images/distr1.png" alt="distr1"></div></div></section>
<section id="_как_мы_делаем_его_похожим_на_настоящий_redis_2"><h2>Как мы делаем его похожим на настоящий  Redis?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Redis: 237 команд различной популярности и важности  (принцип Парето 80/20 тут работает)</p></li><li><p>Jedis-mock: поддерживает 153 команды  (64% и это число растёт)</p></li></ul></div>
<div class="imageblock"><img src="images/pareto.png" alt="pareto"></div></div></section>
<section id="_как_мы_подсчитываем_процент_поддерживаемых_команд"><h2>Как мы подсчитываем процент поддерживаемых команд?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Команда Redis <code>COMMAND</code> выводит список всех поддерживаемых команд (сейчас их 237, с каждой версией число увеличивается)</p></li><li><p>Классы, проаннотированные <code>@Command(&lt;COMMAND_NAME&gt;)</code> реализуют команды в Jedis-mock</p></li></ul></div></div></section>
<section id="_автоматически_создаваемый_fit_gap_report"><h2>Автоматически создаваемый fit-gap report</h2><div class="slide-content"><div class="imageblock"><img src="images/supported_redis_operations.png" alt="supported redis operations"></div></div></section>
<section id="_а_как_мы_убеждаемся_что_команды_работают_правильно"><h2>А как мы убеждаемся, что команды работают правильно?</h2><div class="slide-content"><div class="paragraph"><p>Comparison testing</p></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #3c5d5d;font-weight: bold">@TestTemplate</span>
<span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">whenHSettingOnTheSameKeys_EnsureReturnTypeIs1WhenKeysAreNew</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">Jedis</span> <span style="background-color: #f8f8f8">jedis</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">assertEquals</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">1L</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">jedis</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">hset</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">HASH</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #008080">FIELD_1</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #008080">VALUE_1</span><span style="color: #000000;font-weight: bold">));</span>
    <span style="background-color: #f8f8f8">assertEquals</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">0L</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">jedis</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">hset</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">HASH</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #008080">FIELD_1</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #008080">VALUE_1</span><span style="color: #000000;font-weight: bold">));</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre></div></div></div></section>
<section id="_а_как_мы_убеждаемся_что_команды_работают_правильно_2"><h2>А как мы убеждаемся, что команды работают правильно?</h2><div class="slide-content"><div class="paragraph"><p>Comparison testing</p></div>
<div class="imageblock"><img src="images/comparison.png" alt="comparison" width="50%"></div></div></section>
<section id="_собственные_e2e_тесты_redis"><h2>Собственные E2E тесты Redis</h2><div class="slide-content"><div class="ulist"><ul><li><p>Написаны на Tcl/Tk</p></li></ul></div>
<div class="listingblock"><div class="content"><pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="tcl">test <span style="background-color: #f8f8f8">{</span>INCR over 32bit value<span style="background-color: #f8f8f8">}</span> <span style="background-color: #f8f8f8">{</span>
    r set novar 17179869184
    r incr novar
<span style="background-color: #f8f8f8">}</span> <span style="background-color: #f8f8f8">{</span>17179869185<span style="background-color: #f8f8f8">}</span></code></pre></div></div>
<div class="paragraph"><p>Постепенно увеличиваем количество проходящих тестовых сценариев, проверяем hashsets, sets, zsets, lists, streams</p></div></div></section>
<section id="_redis_in_action"><h2>Redis in Action</h2><div class="slide-content"><table class="tableblock frame-all grid-all" style="width:100%"><colgroup><col style="width:30%"><col style="width:70%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="imageblock"><img src="images/redis-in-action.png" alt="redis in action"></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p>Josiah Carlson</p></li><li><p>2013 (довольно старая, но идейно не устаревшая)</p></li><li><p>Доступна в электронном виде на redis.com</p></li></ul></div></div></td></tr></table></div></section></div></div><script src="reveal.js-3.9.2/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: 'true',
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: false,
  // Push each slide change to the browser history. Implies `hash: true`
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: false,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 0,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: true,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'none',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1600,
  height: 900,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js-3.9.2/plugin/zoom-js/zoom.js', async: true },
      { src: 'reveal.js-3.9.2/plugin/notes/notes.js', async: true }
  ],

  

});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(1600, 900)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(1600, 900)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(1600, 900)
});</script></body></html>